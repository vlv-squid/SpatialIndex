# S2SpatialIndex 项目 README

## 📌 项目简介

本项目实现了一个基于 **S2 空间索引** 和 **R树索引** 的空间查询系统，用于加速对大规模矢量地理数据（如 Shapefile、GeoDatabase）的矩形范围查询。适用于 GIS 数据检索、地图服务、空间分析等场景。

---

## 🧩 主要功能

### 1. **空间索引构建**
- 使用 `S2Geometry`（S2Sphere）将空间要素覆盖到 S2 单元格中，建立空间索引。
- 同时构建 R树索引（使用 `rtree` 库）用于快速外包矩形过滤。
- 支持 SQLite 数据库存储 S2 索引数据，便于持久化与复用。

### 2. **自动层级计算**
- 根据查询范围自动计算合适的 S2 层级，兼顾精度与性能。

### 3. **高效查询**
- 支持多种查询模式：
  - 纯 S2 索引查询
  - S2 + R树加速
  - S2 + 精确外包矩形检查
  - S2 + R树 + 精确检查

### 4. **性能测试模块**
- 提供 [run_performance_test]函数，对比不同查询方式的性能差异。

### 5. **可视化支持**
- 提供 [visualize_results]函数，使用 `matplotlib` 可视化查询结果。

---

## ⚙️ 系统流程

### 1. 初始化索引器
- 指定数据路径（如 GeoDatabase、Shapefile）和索引数据库路径。
- 自动加载已有索引或提示构建新索引。

### 2. 构建索引
- 遍历所有要素，提取其外包矩形并生成 S2 单元格索引。
- 构建 R树索引以加速外包矩形过滤。
- 将索引数据持久化到 SQLite 数据库和磁盘文件中。

### 3. 执行查询
- 输入查询范围（BBox），自动计算最佳 S2 层级。
- 利用 S2 单元格匹配候选要素。
- 可选使用 R树或外包矩形进行精确过滤。

### 4. 性能测试
- 对比不同查询策略的执行效率，输出耗时与结果数量。

### 5. 结果可视化（可选）
- 绘制查询范围与匹配要素，保存为 PNG 图像。

---

## 📦 主要依赖库

- `s2sphere`: S2 空间索引核心库。
- `rtree`: R树索引实现。
- `osgeo`: 用于读取矢量数据（GDAL/OGR）。
- `sqlite3`: 索引数据持久化。
- `matplotlib`: 可视化支持。
- `numpy`: 可选，用于数据处理。

---

## 🛠️ 安装指南

请根据你的环境选择以下方式安装依赖：

### 1. 使用 pip 安装
```bash
pip install -r requirements.txt
```

---

## 🧪 关于数据和查询方式

- 本项目不包含具体数据文件，您可以替换为您自己拥有的任意 GDAL 支持格式的数据文件，并修改相应的查询范围即可使用。
- 建议构建索引为一次性操作，后续可直接加载使用。
- 如有实际项目要求，请使用C/C++实现主体逻辑，能带来更快的查询性能，本项目之提供思路。

---

## 🧪 使用示例

```python
indexer = S2SpatialIndex("./data/test.gdb", s2_level=15)
indexer.build_index()
results = indexer.query_by_bbox((103.2504, 26.4297, 103.3028, 26.4747), use_rtree=True, exact_check=True)
```

---

## 📊 性能测试输出示例

```
===== 性能测试开始 =====

[测试1] 纯GDAL顺序扫描:
耗时: 21.29ms, 结果数: 1727
可视化结果已保存为纯GDAL顺序扫描索引.png

[测试2] 纯S2索引 (无精确验证):
查询完成! 耗时: 15.78ms
候选要素: 2025, 结果要素: 2025
总耗时: 15.86ms
可视化结果已保存为纯S2索引.png

[测试3] S2 + 矩形精确验证:
查询完成! 耗时: 16.44ms
候选要素: 2025, 结果要素: 1729
总耗时: 16.59ms
可视化结果已保存为S2 + 矩形索引.png

[测试4] S2 + R树验证:
查询完成! 耗时: 17.10ms
候选要素: 1729, 结果要素: 1729
总耗时: 17.18ms
可视化结果已保存为S2 + R树索引.png

[测试5] S2 + R树 + 矩形精确验证:
查询完成! 耗时: 17.83ms
候选要素: 1729, 结果要素: 1729
总耗时: 17.92ms
可视化结果已保存为S2 + R树 + 矩形索引.png
===== 性能测试结束 =====
```


## 📈 性能优势

- **S2 索引**：适用于全球范围的空间数据，层级控制灵活。
- **R树索引**：本地快速过滤，减少误匹配。
- **组合策略**：在精度与速度之间取得良好平衡。

---

## 📌 注意事项

- 数据路径需为支持 OGR 读取的格式（如 GeoDatabase、Shapefile）。
- 构建索引为一次性操作，后续可直接加载使用。
- 建议使用 SSD 存储索引文件以提升性能。

---

## 📚 参考资料

- [S2 Geometry](https://s2geometry.io/)
- [RTree](https://toblerity.org/rtree/)
- [GDAL/OGR](https://gdal.org/)

---

## 📝 作者信息

- 创建者：@vlv-squid
- 创建时间：2025-07-17

